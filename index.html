<!DOCTYPE html>
<html>
  <head>
    <title>Lunch 2014 Infographic</title>
    <script src="events.json"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <style>
      body {
        background: #19063A;
        font-family: 'Lucida Grande';
        margin: 0;
        padding: 0;
      }

      header {
        color: white;
        text-align: center;
        padding: 200px 20px 110px;
      }

      header h1 {
        font-weight: lighter;
        font-size: 60px;
      }

      .chart {
        padding: 20px;
      }

      .chart rect {
        fill: steelblue;
        cursor: pointer;
      }

      .chart.locked rect {
        transition: fill .1s;
        fill: #172457;
      }

      .chart .highlight rect {
        transition: fill .1s;
        fill: orange;
      }

      .chart text {
        fill: white;
        font: 10px sans-serif;
        text-anchor: end;
      }

      .chart.locked text.x.axis {
        transition: .1s;
        fill: #4F4F4F;
      }

      .chart .highlight text.x.axis {
        fill: white;
      }

      .chart-information {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: white;
        shape-rendering: crispEdges;
      }

      .x.axis path,
      .y.axis path
      {
        display: none;
      }

      .data-tip {
        line-height: 1;
        font-weight: lighter;
        font-size: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
      }

      .data-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
      }

      .data-tip.n:after {
        margin: -1px 0 0 0;
        top: 100%;
        left: 0;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Chadev+Lunch 2014</h1>
    </header>
    <section class="chart-information">
      <svg class="chart">
      </svg>
    </section>
    <script>
      (function() {
        var margin      = { top: 0, right: 20, bottom: 30, left: 30 },
            width       = 1200,
            height      = 1200,
            barHeight   = 12,
            barWidth    = 18,
            spacer      =  1,
            chartWidth  = 1200,
            chartHeight = 800,
            isHighlightLocked = false;

        d3.json("events.json", function(error, json) {
          if (error) return console.warn(error);
          var events = json;

          var chart = d3.select(".chart")
              .attr('width', width + margin.left + margin.right)
              .attr('height', height + margin.top + margin.bottom)
            .append('g')
              .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

          var xScale = d3.scale.ordinal()
            .domain(events.map(function(d) { return d.name; }))
            .rangeRoundBands([0, chartWidth], 0.1);

          var yScale = d3.scale.linear()
            .domain([0, d3.max(events, function(d) { return d.rsvps.length; })])
            .range([chartHeight, 0]);

          var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient('bottom');

          var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient('left');

          chart.append('g')
            .attr('class', 'y axis')
            .call(yAxis);

          var columns = chart.selectAll('.meetup')
              .data(events)
            .enter().append('g')
              .attr('class', 'g')
              .attr('transform', function(d) {
                return "translate(" + xScale(d.name) + "," + (-barHeight) + ")";
              });

          columns.append('text')
            .attr('transform', 'translate(' + (barWidth) + ', ' + (chartHeight + 15) + ') rotate(-65)' )
            .attr('class', 'x axis')
            .attr('text-anchor', 'end')
            .attr('dx', '-10px')
            .attr('dy', '.15em')
            .text(function(d) { return d.name; });

          var rsvps = columns.selectAll('rect')
              .data(function(d) { return d.rsvps; })
            .enter().append('rect')
              .attr('data-key', function(d) { return d.key; })
              .attr('width', xScale.rangeBand())
              .attr('y', function(d, i) { return yScale(i); })
              .attr('height', barHeight - spacer)
            .on('mouseover', function(d) {
              tip.show(d);
              if (isHighlightLocked) return;

              var cells = document.querySelectorAll(selector(d));
              [].forEach.call(cells, function(cell) {
                cell.parentNode.classList.add('highlight');
              });
            })
            .on('mouseout', function(d) {
              tip.hide(d);
              if (isHighlightLocked) return;

              var highlights = document.querySelectorAll('.highlight');
              [].forEach.call(highlights, function(column) {
                column.classList.remove('highlight');
              });
            })
            .on('click', function(d) {
              isHighlightLocked = !isHighlightLocked;
              document.querySelector('.chart').classList.toggle('locked');
            });

          var tip = d3.tip()
            .attr('class', 'data-tip')
            .offset([-10, 0])
            .html(function(d) {
              var tag = "<span>" + d.name + "</span>";
              return tag;
            });

          chart.call(tip);
        });

        function selector(member) {
          return '[data-key=' + member.key + ']';
        }

        function getChartWidth() {
          var width = parseInt(d3.select('.chart').style('width'), 10);
          return width - margin.left - margin.right;
        }

        function getChartHeight() {
          var height = parseInt(d3.select('.chart').style('height'), 10);
          return height - margin.top - margin.bottom;
        }
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>Lunch 2014 Infographic</title>
    <script src="events.json"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <style>
      body {
        background: #19063A;
      }

      .chart rect {
        fill: steelblue;
      }

      .chart text {
        fill: white;
        font: 10px sans-serif;
        text-anchor: end;
      }

      .chart-information {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .data-tip {
        line-height: 1;
        font-weight: bold;
        padding: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
      }

      .data-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
      }

      .data-tip.n:after {
        margin: -1px 0 0 0;
        top: 100%;
        left: 0;
      }

      .chart .highlight rect {
        transition: fill .4s ease;
        fill: orange;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Lunch stats</h1>
    </header>
    <section class="chart-information">
      <svg class="chart" height="800" width="1000">
      </svg>
    </section>
    <script>
      (function() {
        var chart = d3.select(".chart");

        var margin    = { top: 0, right: 10, bottom: 30, left: 10 },
            width     = getChartWidth(),
            height    = getChartHeight(),
            barHeight = 12,
            barWidth  = 18,
            spacer    =  2;

        var tip = d3.tip()
          .attr('class', 'data-tip')
          .offset([-10, 0])
          .html(function(d) {
            var tag = "<strong>" + d.name + "</strong>";
            return tag;
          });

        chart.call(tip);

        d3.json("events.json", function(error, json) {
          if (error) return console.warn(error);
          var events = json;

          chart.attr('width', width).attr('height', height);

          var xScale = d3.scale.ordinal();
          var yScale = d3.scale.linear()
            .domain([0, d3.max(events, function(event) {
              return event.rsvps.length;
            })])
            .range([height, 0]);

          var xAxis = d3.svg.axis()
            .scale(xScale);

          var yAxis = d3.svg.axis()
            .scale(yScale);

          // d3.select(window).on('resize', resize);

          drawChart();

          function drawChart() {
            var columns = chart.selectAll('g')
                .data(events)
              .enter().append('g')
                .attr('transform', function(d, i) {
                  return "translate(" + i * barWidth + ",0)";
                });

            var rsvps = columns.selectAll('rect')
                .data(function(d) { return d.rsvps; })
              .enter().append('rect')
                .attr('data-key', function(d) { return d.key; })
                .attr('width', barWidth - spacer)
                .attr('y', function(d, i) { return yScale(i); })
                .attr('height', barHeight - spacer)
              .on('mouseover', function(d) {
                tip.show(d);
                var cells = document.querySelectorAll(selector(d));
                [].forEach.call(cells, function(cell) {
                  console.log(cell.parentNode);
                  cell.parentNode.classList.add('highlight');
                });
              })
              .on('mouseout', function(d) {
                tip.hide(d);
                var highlights = document.querySelectorAll('.highlight');
                [].forEach.call(highlights, function(column) {
                  column.classList.remove('highlight');
                });
              });
          }

          // function resize() {
          //   var height = getChartHeigh();

          //   yScale.range([height, 0]);
          // }
        });

        function selector(member) {
          return '[data-key=' + member.key + ']';
        }

        function getChartWidth() {
          var width = parseInt(d3.select('.chart').style('width'), 10);
          return width - margin.left - margin.right;
        }

        function getChartHeight() {
          var height = parseInt(d3.select('.chart').style('height'), 10);
          return height - margin.top - margin.bottom;
        }
      })();
    </script>
  </body>
</html>